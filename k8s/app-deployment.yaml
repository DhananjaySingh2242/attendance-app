apiVersion: apps/v1
kind: Deployment
metadata:
  name: attendance-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: attendance-app
  template:
    metadata:
      labels:
        app: attendance-app
    spec:
      containers:
        - name: attendance-app
          image: dhananjaysingh2242/attendance-app:1.0
          imagePullPolicy: IfNotPresent   # use Never when image is loaded locally (e.g. kind load / minikube)
          ports:
            - name: http
              containerPort: 8081
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:mysql://mysql:3306/attendance?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
            - name: SPRING_DATASOURCE_USERNAME
              value: "attendance"
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: mysql-password
            - name: MONGODB_HOST
              value: "mongodb"
            - name: MONGODB_PORT
              value: "27017"
            - name: SPRING_DATA_MONGODB_PORT
              value: "27017"
            - name: RABBITMQ_HOST
              value: "rabbitmq"
            - name: RABBITMQ_PORT
              value: "5672"
            - name: SPRING_RABBITMQ_PORT
              value: "5672"
            - name: REDIS_HOST
              value: "redis"
            - name: REDIS_PORT
              value: "6379"
            # Force Spring to use numeric port (avoids URL being injected as port)
            - name: SPRING_DATA_REDIS_PORT
              value: "6379"
            - name: KEYCLOAK_ISSUER_URI
              value: "http://keycloak:8080/realms/keycloak-demo"
            - name: KEYCLOAK_AUTH_SERVER_URL
              value: "http://keycloak:8080"
            - name: KEYCLOAK_REALM
              value: "keycloak-demo"
            - name: KEYCLOAK_ADMIN_REALM
              value: "master"
            - name: KEYCLOAK_ADMIN_CLIENT_ID
              value: "attendance-admin-client"
            - name: KEYCLOAK_ADMIN_USERNAME
              value: "admin"
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: admin-password
            - name: KEYCLOAK_ADMIN_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: client-secret
            - name: CORS_ALLOWED_ORIGINS
              value: "http://localhost:5173,http://localhost:3000"
            # Let Hibernate create tables on first run (prod profile uses validate by default; override for k8s/minikube).
            - name: SPRING_JPA_HIBERNATE_DDL_AUTO
              value: "update"
          # App can take 90â€“120s to start (MySQL, MongoDB, Redis, RabbitMQ, Keycloak). Don't probe too early.
          startupProbe:
            httpGet:
              path: /api/health
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 18
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/health
              port: 8081
            initialDelaySeconds: 45
            periodSeconds: 10
            failureThreshold: 6
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /api/health
              port: 8081
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 6
            timeoutSeconds: 5
